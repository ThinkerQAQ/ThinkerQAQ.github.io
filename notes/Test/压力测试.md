[toc]

## 1. 什么是压力测试

- 在性能可以接受的前提下，测试子系统或者接口可以支持的最大负载

## 2. 为什么需要压力测试

- 找出子系统或者接口的瓶颈，才能进行相应的优化和扩容
- 验证子系统或者接口是否能够支撑预估的力量

## 3. 如何设计压力测试计算 QPS

### 3.1. 估算

- 根据吞吐量=并发度/响应时间
  - 如果是计算密集型应用，那么取决于 CPU 核数。假设 CPU 为 4C，接口响应为 100ms，100ms 全部用于 CPU 计算，`QPS=4C/100ms=4C/0.1s=40`
  - 如果是 IO 密集型应用，那么取决于 CPU 核数和每个核能维护的线程数。假设 CPU 为 4C，每个核心能维护 4 个线程，接口响应为 100ms，100ms 中 10ms 用于 CPU 计算，90ms 用于 IO，`QPS=4C*4T/10ms=4C*4T/0.01s=1600`
- 实际开发中一般都是压测，压测的数据肯定介于 40-1600 之间

### 3.2. 实践

#### 3.2.1. 创建压测实例

#### 3.2.2. 缓慢增加并发数

- 200 线程 5s 启动 循环 5 次
- 400 线程 5s 启动 循环 5 次
- 600 线程 5s 启动 循环 5 次
- 800 线程 5s 启动 循环 5 次
- ...

QPS 如果达不到，那么调高并发数

#### 3.2.3. 查看 QPS

![1628258497973](https://raw.githubusercontent.com/TDoct/images/master/1628258511_20210806220145279_30495.png)

- 查看 90、95、99 线的响应时间是否在预期范围内（比如 50ms 以内），是的话可以看出 QPS 大概 500 左右

## 4. 如何准确评估实际QPS

使用伪造的数据压测可能并不准确得反映每个机器的QPS，这种方式仅能适用于上线

搞活动的场景需要准确评估QPS，这就需要真实数据。

1. 容量压测：通过将线上真实的流量引流到需要压测的目标机器上，使用的是真实数据。
设置好需要压测的服务实例、服务路由的权重增长方式、被压测的单机的关键指标（CPU利用率、系统整体负载、QPS、响应时间等）达到的阀值水位后即自动停止压测，以免对生产环境产生大的影响。一旦系统停止压测后，就能在平台上查看到该服务实例在系统资源达到阀值时，单机服
务实例所能提供的最大的QPS处理值
2. 容量规划：能利用服务的单机QPS数据，结合对各种服务器机型处理能力的差异化分析，对到底需要部署多少线上服务器资源才能满足大促活动有更准确的预测
## 5. 如何优化 QPS

根据 QPS=并发/响应时间，有两条路

1. 提高并发度。一方面创建更多的线程，当然这里的前提是 CPU 资源是无限的，而现实情况是 CPU 资源是有限的，所以如果创建太多线程必然会让 CPU 忙于线程调度而使得 QPS 下降；
   另一方面让火焰图中接口的百分比越多越好，说明 CPU 都用于接口了
2. 降级响应时间。这就需要分析程序的瓶颈进而优化。运行程序需要 CPU、内存、磁盘、网络，瓶颈必然就是这几个
   [Linux 性能调优.md](../Operating_System/Linux/性能调优/Linux性能调优.md)

## 6. 例子

### 6.1. WebSocket

[Websocket.jmx](attachments/20200403225445716_30434/Websocket.jmx)
[data.csv](attachments/20200403225445716_30434/data.csv)

## 7. 参考

- [压力测试和性能测试有什么区别？ \- 知乎](https://www.zhihu.com/question/356652638)
- [PV UV QPS 并发数 \- tooltime \- 博客园](https://www.cnblogs.com/insane-Mr-Li/p/10793752.html)
- [java 接口压测：当接口不是瓶颈，机器 cpu 和网络带宽对接口 qps 的影响 \- 简书](https://www.jianshu.com/p/6c54c9005ba2)
- [企业IT架构转型之道：阿里巴巴中台战略思想与架构实战 (豆瓣)](https://book.douban.com/subject/27039508/)
