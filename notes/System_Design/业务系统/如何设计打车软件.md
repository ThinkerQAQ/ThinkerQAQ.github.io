[toc]



## 1. 需求是什么
设计打车软件
## 2. 为什么要做这个需求

## 3. 需求分析
1. 系统中有两个角色：司机、用户
    - 用户：打开软件可以看到周围的司机，输入想去的地方，附近的司机接单后回过来载我
    - 司机：打开软件后可以看到周围的用户打车请求，接受后需要过去载他
3. QPS估算
    1. 假设`DAU（日活跃用户数）`为50W，每个用户操作10次，操作时间分散在24h
    2. 那么`PV（日访问量）=DAU*10=50W*10=500W`
    3. 那么`平均QPS（每秒请求量）=访问量/时长=PV/24h=500W/(24*60*60)=580`
    4. 那么`峰值QPS（每秒请求量）=平均QPS*10=580*10=5800`
## 4. 方案设计


### 4.2. 接口设计
#### 上传自己的位置
定时任务，每5s执行
- Req
    - 经度
    - 纬度
#### 司机响应叫车

#### 用户叫车
#### 用户查询叫车结果

### 4.1. 存储设计

- 根据功能要求、请求量、数据量、存储模型等决定使用那种存储
- 功能
    - MySQL：ACID事务
    - MongoDB：复杂数据模型
    - Redis：快
- 请求量
    - C端
    - 峰值QPS 5800
    
    |   Component   | Reads per second | Writes per second |
    | ------------- | ---------------- | ----------------- |
    | MySQL         | 10000            | 5000              |
    | Redis         | 100000           | 100000            |
    | Kafka | 100000           | 100000            |
    | MongoDB         | 20000-50000      | 10000-25000       |
- 数据量
    - 司机每天数据量=每天请求量*每次请求数据写入量=500W*(8+8)=76MB
    - 保存3天=228MB
    
    |     Component     | Max effective capacity |
    | ----------------- | ---------------------- |
    | MySQL             | 3TB                    |
    | Redis | 16GB-128GB             |
    | MongoDB             |                        |
- 这里需要获取附近的司机，比如经纬度10以内的。用Redis不好实现，剩下MySQL和MongoDB，MySQL需要自己处理分片逻辑麻烦，MongoDB自带分片支持海量数据并且支持地理位置查询选用MongoDB好
- 数据模型设计
    - 用户位置表
        - uid
        - 经度
        - 纬度



### 4.3. 架构设计
![打车系统](https://raw.githubusercontent.com/TDoct/images/master/1647677994_20220319161949454_6469.png)
### 4.4. 代码设计
[类图.md](../Software_Engineering/建模/类图.md)
[组件图.md](../Software_Engineering/建模/组件图.md)

## 5. 工作量评估
- 一个接口评估0.5-2天
## 6. 开发


## 7. 测试
功能测试、单元测试、接口测试、压力测试等
[测试.md](../Test/测试.md)


## 8. 发布
1. 服务发布Checklist
2. 上线部署
    - [部署图.md](建模/部署图.md)
    - 机器数目：可以估算整个系统的请求量，然后二八原则来估算实际QPS，再除以压测出来的QPS

## 9. 运维
2. 梳理核心链路日志和监控
3. 常见问题定位
## 10. 优化
出现问题复盘，通过连续追问，找到根本原因，这个方法叫做 “5W根因分析法”
## 11. 总结

1. 方案对比
2. 遇到的问题以及怎么解决的
3. 设计中的亮点
    - 为什么引入XXX组件
3. 痛点梳理与改进措施
    - 请求量、数据量扩大N倍怎么处理
    - [重构.md](重构.md)
## 12. 参考
- [实用的系统设计【中英字幕 Pragmatic System Design】\_哔哩哔哩\_bilibili](https://www.bilibili.com/video/BV1PF411x7fA?p=38)