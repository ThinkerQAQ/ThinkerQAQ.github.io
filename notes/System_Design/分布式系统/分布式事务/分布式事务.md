## 1. 什么是分布式事务
- 分布式环境下的事务。
- 传统的事务是单个数据库节点的，而分布式事务则是跨多个数据库节点的，甚至是其他数据源比如Redis、MongoDB

## 2. 为什么需要分布式事务
传统的数据库事务只能保证单个库内的事务，跨多个库就不行了
参考[数据库事务.md](../../../Database/数据库事务.md)

## 3. 分布式事务使用场景
- 只在核心链路上都会用分布式事务
- 非核心链路可以使用
    - 对账方案
        - 全量对账：定时任务对比两个数据库
        - 增量对账：定时任务对比更新时间大于今天的数据库
    - 妥协方案
        - 监控报警+人工修复（日志流水需要完整记录）


## 4. 如何实现分布式事务
- [分布式事务方案之2PC.md](分布式事务方案之2PC.md)
- [分布式事务方案之3PC.md](分布式事务方案之3PC.md)
- [分布式事务方案之TCC.md](分布式事务方案之TCC.md)
- [分布式事务方案之Saga.md](分布式事务方案之Saga.md)
- [分布式事务方案之可靠消息最终一致性.md](分布式事务方案之可靠消息最终一致性.md)
- [分布式事务方案之最大努力通知.md](分布式事务方案之最大努力通知.md)

## 5. 分布式事务方案比较

### 5.1. 2PC vs TCC
|           |               2PC                |               TCC                |
| --------- | -------------------------------- | -------------------------------- |
| 分阶段提交 | 两阶段                           | 两阶段                           |
| 层次       | 数据库层（必须是支持ACID的数据库） | 应用层（底层数据源可以不支持ACID） |
| 代码侵入   | 低                               | 高                               |
| 性能问题   | 阶段1                            | 无                             |
| 单点问题   | 阶段2                              | 无                             |
| 一致性问题 | 阶段2                              | 无                             |
| ACID的支持 | AID                              | ACID                             |
| 使用场景 | 单个服务使用多个数据源                              | 多个服务使用多个数据源                             |
### 5.2. TCC vs Saga
|                        |               TCC                |               Saga               |
| ---------------------- | -------------------------------- | -------------------------------- |
| 分阶段提交              | 两阶段                           | 两阶段                           |
| 层次                   | 应用层（底层数据源可以不支持ACID） | 应用层（底层数据源可以不支持ACID） |
| 模式                   | 同步                             | 异步                             |
| 阶段1是否需要预留资源 | 需要                             | 不需要                           |
| ACID的支持              | ACID                             | ACD                             |
| 使用场景 | 多个服务使用多个数据源；强一致性                              | 多个服务使用多个数据源；外部系统；最终一致性                             |
### 5.3. TCC vs 可靠消息最终一致性
|             | TCC  | 可靠消息最终一致性 |
| ----------- | ---- | ----------------- |
| 模式        | 同步 | 异步              |
| 是否可以回滚 | 可以 | 不行              |
| ACID的支持              | ACID                             | ACD                             |
| 使用场景 | 多个服务使用多个数据源；允许失败回滚；强一致性                              | 多个服务使用多个数据源；只允许全部成功；最终一致性                             |
### 5.4. 最大努力通知 VS 可靠消息最终一致性
|         |            最大努力通知            |          可靠消息最终一致性          |
| ------- | --------------------------------- | ----------------------------------- |
| 失败重试 | 由消费者主动查询生产者的接口        | 由生产者定时查询未完成的消息发给消费者 |
| 使用场景 | 多个服务使用多个数据源；允许部分失败 | 多个服务使用多个数据源；只允许全部成功 |



## 6. 一致性算法 vs 分布式事务
|     |               一致性/共识算法                |          分布式事务           |
| --- | ------------------------------------------- | ---------------------------- |
| 定义 | 分布式系统对某件事达成共识                    | 数据库事务ACID特性中C的延申    |
| 举例 | [分布式一致性算法.md](../分布式一致性算法/分布式一致性算法.md) | [分布式事务.md](分布式事务.md) |
- 不是同一个东西。
    - 共识：B节点从A节点复制数据，A、B两个节点中这个数据必须是一样的
    - 一致性：A转账给B 20元，那么A-20，B+20，这样子才叫一致性
## 7. 参考
- [分布式系统一致性问题解决实战\(阿里\) 异步解耦\+消息队列可作为分布式系统满足最终一致性的优秀方案 \- aspirant \- 博客园](https://www.cnblogs.com/aspirant/p/11455095.html)
- [解决业务代码里的分布式事务一致性问题 \- 知乎](https://zhuanlan.zhihu.com/p/25346771)
- [脉脉-假如a调用b调用c，b遇到异常，需要回滚，这时候怎么保证事务性](https://maimai.cn/web/gossip_detail?gid=28859180&egid=37541e6e9b9911eb87bb246e96b48088)
- [微服务架构的分布式事务解决方案\_哔哩哔哩\_bilibili](https://www.bilibili.com/video/BV144411R7Eb)
- [【黑马】分布式事务解决方案专题\_哔哩哔哩\_bilibili](https://www.bilibili.com/video/BV1FJ411A7mV)
- [【黑马】分布式事务专题](file:///E:/Data/calibre/Wei%20Zhi/[(Hei%20Ma%20)]%20Fen%20Bu%20Shi%20Shi%20Wu%20Zhuan%20(636)/[(Hei%20Ma%20)]%20Fen%20Bu%20Shi%20Shi%20Wu%20Z%20-%20Wei%20Zhi.pdf)
- [脉脉-有实际用过分布式事务的吗，最好具体到技术实现](https://maimai.cn/web/gossip_detail?gid=28893679&egid=9bb57dfaa20c11ebb278246e96b48088)
- [6\.824 Home Page: Spring 2021](https://pdos.csail.mit.edu/6.824/)
- [分布式事务方案\(XA 2PC TCC Seata\) \- 知乎](https://zhuanlan.zhihu.com/p/376378186)
- [我还不懂什么是分布式事务 \- 知乎](https://zhuanlan.zhihu.com/p/360516150)
- [请问分布式事务一致性与raft或paxos协议解决的一致性问题是同一回事吗？ \- 知乎](https://www.zhihu.com/question/275845393)
- [分布式事务，这一篇就够了 \| 小米信息部技术团队](https://xiaomi-info.github.io/2020/01/02/distributed-transaction/)